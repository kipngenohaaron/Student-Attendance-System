{% extends 'hod_template/base_template.html' %}

{% block page_title %}
    View Attendance
{% endblock page_title %}

{% block main_content %}
{% load static %}

<section class="content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="card shadow-lg border-0 rounded-3">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
              <i class="fas fa-calendar-check mr-2"></i> View Attendance
            </h3>
            <img src="{% static 'images/school_logo.jpg' %}" alt="Exalted School Logo" height="40" class="rounded-circle">
          </div>

          <div class="card-body">
            <!-- Flash Messages -->
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% endfor %}
            {% endif %}

            <!-- Attendance Filters -->
            <div class="form-group">
              <label><i class="fas fa-book text-primary"></i> Subject</label>
              <select class="form-control" id="subject" name="subject">
                {% for subject in subjects %}
                  <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label><i class="fas fa-calendar-alt text-primary"></i> Session Year</label>
              <select class="form-control" id="session_year_id" name="session_year_id">
                {% for session_year in session_years %}
                  <option value="{{ session_year.id }}">
                    {{ session_year.session_start_year }} - {{ session_year.session_end_year }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="text-right">
              <button type="button" class="btn btn-gradient-primary px-4" id="fetch_attendance">
                <i class="fas fa-search"></i> Fetch Attendance Dates
              </button>
            </div>

            <!-- Attendance Date -->
            <div class="form-group mt-3" id="attendance_block" style="display:none;">
              <label><i class="fas fa-calendar-day text-primary"></i> Attendance Date</label>
              <select class="form-control" id="attendance_date" name="attendance_date"></select>
            </div>

            <div class="text-right" id="fetch_student_block" style="display:none;">
              <button type="button" class="btn btn-success px-4" id="fetch_student">
                <i class="fas fa-users"></i> View Student Attendance
              </button>
            </div>

            <!-- Alert Messages -->
            <div class="mt-3">
              <div class="alert alert-danger" id="error_attendance" style="display:none;"></div>
              <div class="alert alert-success" id="success_attendance" style="display:none;"></div>
            </div>

            <!-- Student Attendance Data -->
            <div class="mt-4" id="student_data"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% endblock main_content %}

{% block custom_js %}
<script>
$(document).ready(function(){
    // Fetch Attendance Dates
    $("#fetch_attendance").click(function(){
        var subject = $("#subject").val();
        var session_year_id = $("#session_year_id").val();

        $.ajax({
            url:'{% url 'admin_get_attendance_dates' %}',
            type:'POST',
            data:{subject:subject, session_year_id:session_year_id},
        })
        .done(function(response){
            var json_data = JSON.parse(response);
            if(json_data.length > 0){
                var html_data = "";
                for (key in json_data){
                    html_data += "<option value='"+ json_data[key]["id"] +"'>"+ json_data[key]["attendance_date"] +"</option>";
                }
                $("#error_attendance").hide();
                $("#attendance_block").fadeIn();
                $("#fetch_student_block").fadeIn();
                $("#attendance_date").html(html_data);
            } else {
                $("#error_attendance").html("No Attendance Data Found.").fadeIn();
                $("#attendance_block").hide();
                $("#fetch_student_block").hide();
            }
        })
        .fail(function(){
            alert("Error retrieving attendance dates.");
        });
    });

    // Fetch Students by Attendance Date
    $("#fetch_student").click(function(){
        var attendance_date = $("#attendance_date").val();

        $.ajax({
            url:'{% url 'admin_get_attendance_student' %}',
            type:'POST',
            data:{attendance_date:attendance_date},
        })
        .done(function(response){
            var json_data = JSON.parse(response);
            var div_data = `
              <div class='card mt-3'>
                <div class='card-header bg-info text-white'>
                  <h5 class='mb-0'><i class='fas fa-user-check'></i> Student Attendance List</h5>
                </div>
                <div class='card-body'>
                  <div class='row'>
            `;
            for (key in json_data){
                div_data += `
                  <div class='col-md-4 mb-2'>
                    <div class='border rounded p-2 bg-light'>
                      <strong>${json_data[key]['name']}</strong><br>
                      <span class='badge ${json_data[key]['status'] ? 'badge-success' : 'badge-danger'}'>
                        ${json_data[key]['status'] ? 'Present' : 'Absent'}
                      </span>
                    </div>
                  </div>
                `;
            }
            div_data += `
                  </div>
                </div>
              </div>
            `;
            $("#student_data").hide().html(div_data).fadeIn();
        })
        .fail(function(){
            alert("Error fetching student data.");
        });
    });
});
</script>
{% endblock custom_js %}

{% extends 'staff_template/base_template.html' %}

{% block page_title %}
    Add Result
{% endblock page_title %}

{% block main_content %}
{% load static %}

<section class="content">
  <div class="container-fluid">

    <div class="row justify-content-center">
      <div class="col-md-10">
        <form method="POST" action="{% url 'staff_add_result_save' %}">
          {% csrf_token %}

          <div class="card shadow-lg border-0" style="border-radius: 15px;">
            <div class="card-header text-white" style="background: linear-gradient(90deg, #004aad, #0d6efd); border-top-left-radius: 15px; border-top-right-radius: 15px;">
              <h3 class="card-title mb-0"><i class="fas fa-clipboard-check"></i> Add Student Result</h3>
            </div>

            <div class="card-body p-4">

              {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert" style="border-radius: 8px;">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                {% endfor %}
              {% endif %}

              <div class="form-group mb-4">
                <label class="fw-bold"><i class="fas fa-book"></i> Subject</label>
                <select class="form-control form-select shadow-sm" name="subject" id="subject">
                  {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group mb-4">
                <label class="fw-bold"><i class="fas fa-calendar-alt"></i> Session Year</label>
                <select class="form-control form-select shadow-sm" name="session_year" id="session_year">
                  {% for session_year in session_years %}
                    <option value="{{ session_year.id }}">{{ session_year.session_start_year }} to {{ session_year.session_end_year }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="text-center">
                <button type="button" class="btn btn-primary btn-lg shadow" id="fetch_student" style="border-radius: 10px;">
                  <i class="fas fa-search"></i> Fetch Students
                </button>
              </div>

              <div id="student_data" class="mt-4"></div>

            </div>

            <div class="card-footer text-center text-muted" style="border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;">
              <small><i class="fas fa-lightbulb"></i> Select subject & session to load students.</small>
            </div>
          </div>
        </form>
      </div>
    </div>

  </div>
</section>
{% endblock main_content %}

{% block custom_js %}
<script>
  $(document).ready(function(){

    $("#fetch_student").click(function(){
      var subject = $("#subject").val();
      var session_year = $("#session_year").val();

      if(!subject || !session_year){
        Swal.fire({
          icon: 'warning',
          title: 'Missing Fields',
          text: 'Please select both Subject and Session Year.',
          confirmButtonColor: '#0d6efd'
        });
        return;
      }

      $.ajax({
        url: '{% url "get_students" %}',
        type: 'POST',
        data: { subject: subject, session_year: session_year },
      })
      .done(function(response){
        var json_data = JSON.parse(response);
        if (json_data.length === 0) {
          $("#student_data").html("<div class='alert alert-info'>No students found for the selected subject and session.</div>");
          return;
        }

        var div_data = `
          <div class="card mt-3 shadow-sm">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-user-graduate"></i> Student List</h5>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="fw-bold">Select Student</label>
                <select class="form-control form-select shadow-sm" name="student_list">
        `;

        for (key in json_data) {
          div_data += `<option value='${json_data[key]['id']}'>${json_data[key]['name']} (ID: ${json_data[key]['id']})</option>`;
        }

        div_data += `
                </select>
              </div>

              <div class="row mt-4">
                <div class="col-md-6 mb-3">
                  <label class="fw-bold"><i class="fas fa-pencil-alt"></i> Assignment Marks</label>
                  <input type="number" name="assignment_marks" class="form-control shadow-sm" placeholder="Enter Assignment Marks" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="fw-bold"><i class="fas fa-file-signature"></i> Exam Marks</label>
                  <input type="number" name="exam_marks" class="form-control shadow-sm" placeholder="Enter Exam Marks" required>
                </div>
              </div>

              <div class="text-center mt-3">
                <button id="save_result" class="btn btn-success btn-lg shadow" type="submit" style="border-radius: 10px;">
                  <i class="fas fa-save"></i> Save Result
                </button>
              </div>
            </div>
          </div>`;

        $("#student_data").html(div_data);
      })
      .fail(function(){
        Swal.fire({
          icon: 'error',
          title: 'Error Fetching Students',
          text: 'Something went wrong while loading students. Please try again.',
          confirmButtonColor: '#dc3545'
        });
      });
    });
  });
</script>

<!-- Include SweetAlert2 for stylish popups -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock custom_js %}

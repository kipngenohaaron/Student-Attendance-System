{% extends 'staff_template/base_template.html' %}

{% block page_title %}
    Take Attendance
{% endblock page_title %}

{% block main_content %}
{% load static %}

<section class="content">
  <div class="container-fluid">

    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="card shadow-lg border-0" style="border-radius: 15px;">
          
          <div class="card-header text-white" style="background: linear-gradient(90deg, #0d6efd, #004aad); border-top-left-radius: 15px; border-top-right-radius: 15px;">
            <h3 class="card-title mb-0"><i class="fas fa-check-circle"></i> Take Attendance</h3>
          </div>

          <div class="card-body p-4">

            {% if messages %}
              <div class="form-group">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert" style="border-radius: 8px;">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="form-group mb-4">
              <label class="fw-bold"><i class="fas fa-book"></i> Subject</label>
              <select class="form-control form-select shadow-sm" id="subject" name="subject">
                {% for subject in subjects %}
                  <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group mb-4">
              <label class="fw-bold"><i class="fas fa-calendar-alt"></i> Session Year</label>
              <select class="form-control form-select shadow-sm" id="session_year" name="session_year">
                {% for session_year in session_years %}
                  <option value="{{ session_year.id }}">{{ session_year.session_start_year }} to {{ session_year.session_end_year }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="text-center">
              <button type="button" class="btn btn-primary btn-lg shadow" id="fetch_student" style="border-radius: 10px;">
                <i class="fas fa-search"></i> Fetch Students
              </button>
            </div>

          </div>

          <div class="card-footer bg-light" id="student_data" style="border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;">
            <!-- Students will be displayed here -->
          </div>

        </div>
      </div>
    </div>

  </div>
</section>
{% endblock main_content %}


{% block custom_js %}
<script>
  $(document).ready(function(){
    $("#fetch_student").click(function(){
      var subject = $("#subject").val();
      var session_year = $("#session_year").val();

      $.ajax({
        url: '{% url "get_students" %}',
        type: 'POST',
        data: { subject: subject, session_year: session_year },
      })

      .done(function(response){
        var json_data = JSON.parse(response);
        var div_data = `
          <div class="form-group mt-3">
            <label class="fw-bold"><i class="fas fa-calendar-day"></i> Attendance Date:</label>
            <input type="date" name="attendance_date" id="attendance_date" class="form-control shadow-sm" />
          </div>
          <div class="form-group mt-4">
            <div class="row">`;

        for (key in json_data) {
          div_data += `
            <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
              <div class="form-check border p-2 rounded shadow-sm" style="background-color:#f9f9f9;">
                <input type="checkbox" class="form-check-input" checked name="student_data[]" value="${json_data[key]['id']}" id="student_${json_data[key]['id']}">
                <label class="form-check-label" for="student_${json_data[key]['id']}">${json_data[key]['name']}</label>
              </div>
            </div>`;
        }

        div_data += `
            </div>
          </div>
          <div class="form-group text-center mt-4">
            <button id="save_attendance" class="btn btn-success btn-lg shadow" type="button" style="border-radius: 10px;">
              <i class="fas fa-save"></i> Save Attendance
            </button>
          </div>`;

        $("#student_data").html(div_data);
      })
      .fail(function(){
        alert("Error fetching students. Please try again.");
      });

      $(document).on("click", "#save_attendance", function(){
        $(this).attr("disabled", "disabled").html('<i class="fas fa-spinner fa-spin"></i> Saving...');

        var student_data = $("input[name='student_data[]']").map(function(){
          return { "id": $(this).val(), "status": $(this).is(":checked") ? 1 : 0 };
        }).get();

        var attendance_date = $("#attendance_date").val();
        var subject_id = $("#subject").val();
        var session_year_id = $("#session_year").val();
        student_data = JSON.stringify(student_data);

        $.ajax({
          url: '{% url "save_attendance_data" %}',
          type: 'POST',
          data: {
            student_ids: student_data,
            attendance_date: attendance_date,
            subject_id: subject_id,
            session_year_id: session_year_id
          },
        })

        .done(function(response){
          if(response == "OK"){
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Attendance saved successfully.',
              timer: 2000,
              showConfirmButton: false
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Oops!',
              text: 'Failed to save attendance. Please try again.'
            });
          }
          setTimeout(() => location.reload(), 2000);
        })
        .fail(function(){
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Could not save attendance data.'
          });
        });
      });
    });
  });
</script>

<!-- SweetAlert2 for modern popups -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock custom_js %}

{% extends 'staff_template/base_template.html' %}

{% block page_title %}
    View / Update Attendance
{% endblock page_title %}

{% block main_content %}
{% load static %}

<section class="content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-md-10">

        <div class="card shadow-lg border-0 rounded-4" style="background-color: #f9fbfd;">
          <div class="card-header text-white" style="background: linear-gradient(90deg, #0d6efd, #014f86);">
            <h3 class="card-title mb-0">
              <i class="fas fa-calendar-check mr-2"></i> View / Update Attendance
            </h3>
          </div>

          <div class="card-body">
            <!-- Messages -->
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2 shadow-sm" role="alert">
                  <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% endfor %}
            {% endif %}

            <!-- Selection fields -->
            <div class="row mt-3">
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold"><i class="fas fa-book"></i> Subject</label>
                <select class="form-control shadow-sm" name="subject" id="subject">
                  {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="font-weight-bold"><i class="fas fa-calendar"></i> Session Year</label>
                <select class="form-control shadow-sm" name="session_year_id" id="session_year_id">
                  {% for session_year in session_years %}
                    <option value="{{ session_year.id }}">{{ session_year.session_start_year }} to {{ session_year.session_end_year }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="text-center mb-4">
              <button type="button" class="btn btn-primary px-4" id="fetch_attendance">
                <i class="fas fa-search"></i> Fetch Attendance Dates
              </button>
            </div>

            <!-- Attendance date block -->
            <div class="form-group" id="attendance_block" style="display:none;">
              <label class="font-weight-bold"><i class="fas fa-clock"></i> Attendance Date</label>
              <select class="form-control shadow-sm" name="attendance_date" id="attendance_date"></select>
            </div>

            <div id="error_attendance" class="alert alert-danger mt-3" style="display:none;"></div>
            <div id="success_attendance" class="alert alert-success mt-3" style="display:none;"></div>

            <div class="text-center mt-3" id="fetch_student_block" style="display:none;">
              <button type="button" class="btn btn-success px-4" id="fetch_student">
                <i class="fas fa-users"></i> Fetch Student Data
              </button>
            </div>

            <div id="loading_spinner" class="text-center my-3" style="display:none;">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p class="mt-2 text-muted">Fetching data, please wait...</p>
            </div>

            <div id="student_data" class="mt-4"></div>
          </div>

          <div class="card-footer text-muted text-center">
            <small><i class="fas fa-school"></i> Exalted School Attendance Management System</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% endblock main_content %}

{% block custom_js %}
<script>
$(document).ready(function(){

  // Fetch Attendance Dates
  $("#fetch_attendance").click(function(){
    var subject = $("#subject").val();
    var session_year_id = $("#session_year_id").val();

    $("#loading_spinner").show();

    $.ajax({
      url: '{% url "get_attendance_dates" %}',
      type: 'POST',
      data: { subject: subject, session_year_id: session_year_id },
    })
    .done(function(response){
      $("#loading_spinner").hide();
      var json_data = JSON.parse(response);
      if(json_data.length > 0){
        var html_data = "";
        for(key in json_data){
          html_data += "<option value='"+ json_data[key]["id"] +"'>"+ json_data[key]["attendance_date"] +"</option>";
        }
        $("#attendance_block").show();
        $("#fetch_student_block").show();
        $("#attendance_date").html(html_data);
        $("#error_attendance").hide();
      } else {
        $("#error_attendance").html("⚠️ No Attendance Data Found.").show();
        $("#attendance_block").hide();
        $("#fetch_student_block").hide();
      }
    })
    .fail(function(){
      $("#loading_spinner").hide();
      alert("Error fetching attendance dates.");
    });
  });

  // Fetch Students
  $("#fetch_student").click(function(){
    var attendance_date = $("#attendance_date").val();
    $("#loading_spinner").show();

    $.ajax({
      url: '{% url "get_attendance_student" %}',
      type: 'POST',
      data: { attendance_date: attendance_date },
    })
    .done(function(response){
      $("#loading_spinner").hide();
      var json_data = JSON.parse(response);
      var div_data = `
        <div class="card mt-3 shadow-sm">
          <div class="card-body">
            <h5 class="text-primary mb-3"><i class="fas fa-user-graduate"></i> Student Attendance</h5>
            <div class="row">
      `;
      for(key in json_data){
        div_data += `
          <div class="col-md-4 mb-3">
            <div class="form-check border rounded p-2 shadow-sm bg-white">
              <input type="checkbox" class="form-check-input" name="student_data[]" value="${json_data[key]['id']}" ${json_data[key]['status'] ? 'checked' : ''}>
              <label class="form-check-label">${json_data[key]['name']}</label>
              <span class="badge ${json_data[key]['status'] ? 'bg-success' : 'bg-danger'} ml-2">${json_data[key]['status'] ? 'Present' : 'Absent'}</span>
            </div>
          </div>`;
      }
      div_data += `
            </div>
            <div class="text-center mt-3">
              <button id="save_attendance" class="btn btn-primary px-4"><i class="fas fa-save"></i> Save Attendance</button>
            </div>
          </div>
        </div>`;
      $("#student_data").html(div_data);
    })
    .fail(function(){
      $("#loading_spinner").hide();
      alert("Error fetching student data.");
    });
  });

  // Save Attendance
  $(document).on("click", "#save_attendance", function(){
    $(this).prop("disabled", true).text("Saving...");

    var student_data = $("input[name='student_data[]']").map(function(){
      return { id: $(this).val(), status: $(this).is(":checked") ? 1 : 0 };
    }).get();

    var attendance_date = $("#attendance_date").val();

    $.ajax({
      url: '{% url "update_attendance_data" %}',
      type: 'POST',
      data: { student_ids: JSON.stringify(student_data), attendance_date: attendance_date },
    })
    .done(function(response){
      alert(response == "OK" ? "✅ Attendance Saved Successfully!" : "❌ Failed to Save Attendance!");
      location.reload();
    })
    .fail(function(){
      alert("Error saving attendance data.");
    });
  });

});
</script>
{% endblock custom_js %}
